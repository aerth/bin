#!/bin/sh
# this is the script that powers the automatic cron builds
# 	at ftp://ftp.isupon.us/bin/
#
# soon: cross compilation, makefile support, 
# "./..." support, and some kind of web hook
#
#
# Try: OUTPUT=$HOME/pkgs auto-go-build github.com/aerth/slow
#
# - aerth was here

set -e
# set OUTPUT variable to save packages elsewhere
output=${OUTPUT:="/tmp"}

if [ -z "$1" ]; then
echo [auto go build]
echo Need target go package.
echo Usage: $(basename "$0") github.com/aerth/slow
exit 1
fi

mkdir -p $output

unset CDPATH

if [ ! -z "$GOPATH" ];then
unset GOPATH
fi

export GOPATH=/tmp/go

# as root!?
if [ "`id -u`" = "0" ]; then
echo Not as root!
exit 1
else
export GOBIN=/tmp/bin
mkdir -p /tmp/bin
fi

# check for go
if [ -z $(which go) ]; then
echo you dont have go installed.
exit 1
fi

# check for go
if [ -z $(which go) ]; then
echo you dont have godep installed.
echo \'go get -v github.com/tools/godep\'
exit 1
fi

####
# install a go program
####
base=$(basename $1)-$(uname -s)-$(uname -m).tar.gz
go get -v -u "$1"
cd $GOPATH/src/$1 && godep go build && tar czf $output/$base .
#cd $GOPATH/src/$1 && godep save ./... && godep go build && tar czf $output/$base .
sha256sum $output/$base > $output/$base.sha256.txt
echo "[ready] $output/$base"

unset GOPATH
unset GOBIN
unset GOTAR
rm -Rf /tmp/go

